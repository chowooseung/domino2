# domino
from domino import component
from domino.core import (
    attribute,
    Name,
    Joint,
    NurbsCurve,
    rigkit,
    Transform,
    NurbsSurface,
    Mesh,
)
from domino.core.utils import build_log

# maya
from maya.api import OpenMaya as om
from maya import cmds
from maya import mel

# built-ins
import logging

# gui
from PySide6 import QtWidgets


# region Initialize Settings
ORIGINMATRIX = om.MMatrix()
matrices = [list(ORIGINMATRIX)]
DATA = [
    attribute.String(longName="component", value="chain01"),
    attribute.String(longName="name", value="chain"),
    attribute.Enum(longName="side", enumName=Name.side_list, value=0),
    attribute.Integer(longName="index", minValue=0),
    attribute.Matrix(longName="guide_matrix", multi=True, value=matrices),
    attribute.Matrix(longName="npo_matrix", multi=True, value=matrices),
    attribute.Matrix(
        longName="initialize_output_matrix",
        multi=True,
        value=matrices,
    ),
    attribute.Matrix(
        longName="initialize_output_inverse_matrix",
        multi=True,
        value=matrices,
    ),
    attribute.Integer(longName="guide_mirror_type", multi=True, value=[1]),
    # 부모로 사용할 상위 component 의 output index
    attribute.Integer(
        longName="parent_output_index", minValue=-1, defaultValue=-1, value=-1
    ),
    # output joint 생성 option
    attribute.Bool(longName="create_output_joint", value=1),
    # offset output rotate
    attribute.DoubleAngle(
        longName="offset_output_rotate_x", minValue=-360, maxValue=360
    ),
    attribute.DoubleAngle(
        longName="offset_output_rotate_y", minValue=-360, maxValue=360
    ),
    attribute.DoubleAngle(
        longName="offset_output_rotate_z", minValue=-360, maxValue=360
    ),
    attribute.Float(longName="radius", minValue=0, value=0.23),
    attribute.Float(longName="width", minValue=0, value=1),
    attribute.Float(longName="height", minValue=0, value=1.5),
    attribute.Float(longName="bevel", minValue=0, value=0.5),
    attribute.Float(longName="next_chain_offset", minValue=0, value=0),
    attribute.Integer(longName="master_layer_count", minValue=2, value=2),
    attribute.Integer(longName="sub_layer_count", minValue=2, value=4),
    attribute.Float(
        longName="sub_driver_u_values", multi=True, value=[0, 0.25, 0.5, 0.75, 1]
    ),
    attribute.Matrix(longName="sub_driver_matrix", multi=True, value=matrices),
    attribute.Matrix(longName="sub_driver_inverse_matrix", multi=True, value=matrices),
    attribute.Integer(longName="chain_count", minValue=2, value=2),
    attribute.Float(longName="chain_distance", minValue=0, value=1),
    attribute.Float(longName="surface_width", minValue=0, value=1),
    attribute.Float(longName="scaled_radius", minValue=0, value=0.5),
    attribute.Float(longName="scaled_width", minValue=0, value=2.5),
    attribute.Float(longName="scaled_height", minValue=0, value=4),
    attribute.Float(longName="scaled_next_chain_offset", minValue=0, value=0),
    attribute.DoubleAngle(longName="main_ik_rotate_x", value=[0], multi=True),
    attribute.DoubleAngle(longName="main_ik_rotate_y", value=[0], multi=True),
    attribute.DoubleAngle(longName="main_ik_rotate_z", value=[0], multi=True),
    attribute.DoubleAngle(longName="up_ik_rotate_x", value=[0], multi=True),
    attribute.DoubleAngle(longName="up_ik_rotate_y", value=[0], multi=True),
    attribute.DoubleAngle(longName="up_ik_rotate_z", value=[0], multi=True),
    attribute.DoubleAngle(longName="dyn_ik_rotate_x", value=[0], multi=True),
    attribute.DoubleAngle(longName="dyn_ik_rotate_y", value=[0], multi=True),
    attribute.DoubleAngle(longName="dyn_ik_rotate_z", value=[0], multi=True),
    attribute.NurbsSurface(longName="master_layer_surface"),
    attribute.NurbsSurface(longName="sub_layer_surface"),
    attribute.Mesh(
        longName="chain_mesh",
        value={
            "parent_name": "",
            "mesh_name": "chain_mesh",
            "mesh_matrix": [
                1.0,
                0.0,
                0.0,
                0.0,
                0.0,
                1.0,
                0.0,
                0.0,
                0.0,
                0.0,
                1.0,
                0.0,
                0.0,
                0.0,
                0.0,
                1.0,
            ],
            "visibility": True,
            "mesh": {
                "vertices": [
                    [
                        0.43529993295669556,
                        0.31626397371292114,
                        0.19134172797203064,
                        1.0,
                    ],
                    [0.16626973450183868, 0.5117258429527283, 0.19134172797203064, 1.0],
                    [
                        -0.16626983880996704,
                        0.5117257237434387,
                        0.19134172797203064,
                        1.0,
                    ],
                    [-0.43529999256134033, 0.316263884305954, 0.19134172797203064, 1.0],
                    [
                        -0.5380603075027466,
                        -3.207088994372498e-08,
                        0.19134172797203064,
                        1.0,
                    ],
                    [
                        -0.43529993295669556,
                        -0.31626394391059875,
                        0.19134172797203064,
                        1.0,
                    ],
                    [
                        -0.16626974940299988,
                        -0.5117257237434387,
                        0.19134172797203064,
                        1.0,
                    ],
                    [
                        0.16626977920532227,
                        -0.5117257237434387,
                        0.19134172797203064,
                        1.0,
                    ],
                    [0.43529990315437317, -0.316263884305954, 0.19134172797203064, 1.0],
                    [0.5380602478981018, 0.0, 0.19134172797203064, 1.0],
                    [0.6542183756828308, 0.4753175675868988, 0.4619397521018982, 1.0],
                    [0.24988912045955658, 0.7690799236297607, 0.4619397521018982, 1.0],
                    [-0.2498892843723297, 0.7690798044204712, 0.4619397521018982, 1.0],
                    [-0.6542184352874756, 0.47531741857528687, 0.4619397521018982, 1.0],
                    [
                        -0.8086584210395813,
                        -4.8199790825265154e-08,
                        0.4619397521018982,
                        1.0,
                    ],
                    [
                        -0.6542183756828308,
                        -0.47531750798225403,
                        0.4619397521018982,
                        1.0,
                    ],
                    [
                        -0.24988913536071777,
                        -0.7690798044204712,
                        0.4619397521018982,
                        1.0,
                    ],
                    [0.24988919496536255, -0.7690797448158264, 0.4619397521018982, 1.0],
                    [0.654218316078186, -0.47531741857528687, 0.4619397521018982, 1.0],
                    [0.8086583018302917, 0.0, 0.4619397521018982, 1.0],
                    [0.9638158082962036, 0.7002533078193665, 0.4619397521018982, 1.0],
                    [0.36814478039741516, 1.1330336332321167, 0.4619397521018982, 1.0],
                    [-0.36814504861831665, 1.1330333948135376, 0.4619397521018982, 1.0],
                    [-0.9638159275054932, 0.7002531290054321, 0.4619397521018982, 1.0],
                    [
                        -1.1913418769836426,
                        -7.100950227822977e-08,
                        0.4619397521018982,
                        1.0,
                    ],
                    [-0.9638158082962036, -0.7002532482147217, 0.4619397521018982, 1.0],
                    [
                        -0.36814481019973755,
                        -1.1330333948135376,
                        0.4619397521018982,
                        1.0,
                    ],
                    [0.3681448996067047, -1.1330333948135376, 0.4619397521018982, 1.0],
                    [0.9638157486915588, -0.7002531290054321, 0.4619397521018982, 1.0],
                    [1.191341757774353, 0.0, 0.4619397521018982, 1.0],
                    [1.1827342510223389, 0.8593069314956665, 0.19134169816970825, 1.0],
                    [0.45176416635513306, 1.3903876543045044, 0.19134169816970825, 1.0],
                    [
                        -0.45176446437835693,
                        1.3903875350952148,
                        0.19134169816970825,
                        1.0,
                    ],
                    [-1.1827343702316284, 0.8593066334724426, 0.19134169816970825, 1.0],
                    [
                        -1.4619399309158325,
                        -8.713840315976995e-08,
                        0.19134169816970825,
                        1.0,
                    ],
                    [-1.1827342510223389, -0.859306812286377, 0.19134169816970825, 1.0],
                    [
                        -0.45176422595977783,
                        -1.3903875350952148,
                        0.19134169816970825,
                        1.0,
                    ],
                    [0.451764315366745, -1.3903874158859253, 0.19134169816970825, 1.0],
                    [1.1827341318130493, -0.8593066334724426, 0.19134169816970825, 1.0],
                    [1.461939811706543, 0.0, 0.19134169816970825, 1.0],
                    [1.1827342510223389, 0.8593069314956665, -0.19134171307086945, 1.0],
                    [
                        0.45176416635513306,
                        1.3903876543045044,
                        -0.19134171307086945,
                        1.0,
                    ],
                    [
                        -0.45176446437835693,
                        1.3903875350952148,
                        -0.19134171307086945,
                        1.0,
                    ],
                    [
                        -1.1827343702316284,
                        0.8593066334724426,
                        -0.19134171307086945,
                        1.0,
                    ],
                    [
                        -1.4619399309158325,
                        -8.713840315976995e-08,
                        -0.19134171307086945,
                        1.0,
                    ],
                    [
                        -1.1827342510223389,
                        -0.859306812286377,
                        -0.19134171307086945,
                        1.0,
                    ],
                    [
                        -0.45176422595977783,
                        -1.3903875350952148,
                        -0.19134171307086945,
                        1.0,
                    ],
                    [0.451764315366745, -1.3903874158859253, -0.19134171307086945, 1.0],
                    [
                        1.1827341318130493,
                        -0.8593066334724426,
                        -0.19134171307086945,
                        1.0,
                    ],
                    [1.461939811706543, 0.0, -0.19134171307086945, 1.0],
                    [0.9638156890869141, 0.7002532482147217, -0.4619397521018982, 1.0],
                    [0.3681447505950928, 1.1330335140228271, -0.4619397521018982, 1.0],
                    [-0.3681449890136719, 1.133033275604248, -0.4619397521018982, 1.0],
                    [-0.9638158679008484, 0.7002530097961426, -0.4619397521018982, 1.0],
                    [
                        -1.191341757774353,
                        -7.100949517280242e-08,
                        -0.4619397521018982,
                        1.0,
                    ],
                    [
                        -0.9638156890869141,
                        -0.7002531886100769,
                        -0.4619397521018982,
                        1.0,
                    ],
                    [
                        -0.36814478039741516,
                        -1.133033275604248,
                        -0.4619397521018982,
                        1.0,
                    ],
                    [0.3681448698043823, -1.133033275604248, -0.4619397521018982, 1.0],
                    [0.9638156294822693, -0.7002530097961426, -0.4619397521018982, 1.0],
                    [1.1913416385650635, 0.0, -0.4619397521018982, 1.0],
                    [0.6542183756828308, 0.4753175675868988, -0.4619397521018982, 1.0],
                    [0.24988912045955658, 0.7690799236297607, -0.4619397521018982, 1.0],
                    [-0.2498892843723297, 0.7690798044204712, -0.4619397521018982, 1.0],
                    [
                        -0.6542184352874756,
                        0.47531741857528687,
                        -0.4619397521018982,
                        1.0,
                    ],
                    [
                        -0.8086584210395813,
                        -4.8199790825265154e-08,
                        -0.4619397521018982,
                        1.0,
                    ],
                    [
                        -0.6542183756828308,
                        -0.47531750798225403,
                        -0.4619397521018982,
                        1.0,
                    ],
                    [
                        -0.24988913536071777,
                        -0.7690798044204712,
                        -0.4619397521018982,
                        1.0,
                    ],
                    [
                        0.24988919496536255,
                        -0.7690797448158264,
                        -0.4619397521018982,
                        1.0,
                    ],
                    [0.654218316078186, -0.47531741857528687, -0.4619397521018982, 1.0],
                    [0.8086583018302917, 0.0, -0.4619397521018982, 1.0],
                    [
                        0.43529993295669556,
                        0.31626397371292114,
                        -0.19134169816970825,
                        1.0,
                    ],
                    [
                        0.16626973450183868,
                        0.5117258429527283,
                        -0.19134169816970825,
                        1.0,
                    ],
                    [
                        -0.16626983880996704,
                        0.5117257237434387,
                        -0.19134169816970825,
                        1.0,
                    ],
                    [
                        -0.43529999256134033,
                        0.316263884305954,
                        -0.19134169816970825,
                        1.0,
                    ],
                    [
                        -0.5380603075027466,
                        -3.207088994372498e-08,
                        -0.19134169816970825,
                        1.0,
                    ],
                    [
                        -0.43529993295669556,
                        -0.31626394391059875,
                        -0.19134169816970825,
                        1.0,
                    ],
                    [
                        -0.16626974940299988,
                        -0.5117257237434387,
                        -0.19134169816970825,
                        1.0,
                    ],
                    [
                        0.16626977920532227,
                        -0.5117257237434387,
                        -0.19134169816970825,
                        1.0,
                    ],
                    [
                        0.43529990315437317,
                        -0.316263884305954,
                        -0.19134169816970825,
                        1.0,
                    ],
                    [0.5380602478981018, 0.0, -0.19134169816970825, 1.0],
                ],
                "polygon_counts": [
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                ],
                "polygon_connects": [
                    1,
                    0,
                    10,
                    11,
                    2,
                    1,
                    11,
                    12,
                    3,
                    2,
                    12,
                    13,
                    4,
                    3,
                    13,
                    14,
                    5,
                    4,
                    14,
                    15,
                    6,
                    5,
                    15,
                    16,
                    7,
                    6,
                    16,
                    17,
                    8,
                    7,
                    17,
                    18,
                    9,
                    8,
                    18,
                    19,
                    0,
                    9,
                    19,
                    10,
                    11,
                    10,
                    20,
                    21,
                    12,
                    11,
                    21,
                    22,
                    13,
                    12,
                    22,
                    23,
                    14,
                    13,
                    23,
                    24,
                    15,
                    14,
                    24,
                    25,
                    16,
                    15,
                    25,
                    26,
                    17,
                    16,
                    26,
                    27,
                    18,
                    17,
                    27,
                    28,
                    19,
                    18,
                    28,
                    29,
                    10,
                    19,
                    29,
                    20,
                    21,
                    20,
                    30,
                    31,
                    22,
                    21,
                    31,
                    32,
                    23,
                    22,
                    32,
                    33,
                    24,
                    23,
                    33,
                    34,
                    25,
                    24,
                    34,
                    35,
                    26,
                    25,
                    35,
                    36,
                    27,
                    26,
                    36,
                    37,
                    28,
                    27,
                    37,
                    38,
                    29,
                    28,
                    38,
                    39,
                    20,
                    29,
                    39,
                    30,
                    31,
                    30,
                    40,
                    41,
                    32,
                    31,
                    41,
                    42,
                    33,
                    32,
                    42,
                    43,
                    34,
                    33,
                    43,
                    44,
                    35,
                    34,
                    44,
                    45,
                    36,
                    35,
                    45,
                    46,
                    37,
                    36,
                    46,
                    47,
                    38,
                    37,
                    47,
                    48,
                    39,
                    38,
                    48,
                    49,
                    30,
                    39,
                    49,
                    40,
                    41,
                    40,
                    50,
                    51,
                    42,
                    41,
                    51,
                    52,
                    43,
                    42,
                    52,
                    53,
                    44,
                    43,
                    53,
                    54,
                    45,
                    44,
                    54,
                    55,
                    46,
                    45,
                    55,
                    56,
                    47,
                    46,
                    56,
                    57,
                    48,
                    47,
                    57,
                    58,
                    49,
                    48,
                    58,
                    59,
                    40,
                    49,
                    59,
                    50,
                    51,
                    50,
                    60,
                    61,
                    52,
                    51,
                    61,
                    62,
                    53,
                    52,
                    62,
                    63,
                    54,
                    53,
                    63,
                    64,
                    55,
                    54,
                    64,
                    65,
                    56,
                    55,
                    65,
                    66,
                    57,
                    56,
                    66,
                    67,
                    58,
                    57,
                    67,
                    68,
                    59,
                    58,
                    68,
                    69,
                    50,
                    59,
                    69,
                    60,
                    61,
                    60,
                    70,
                    71,
                    62,
                    61,
                    71,
                    72,
                    63,
                    62,
                    72,
                    73,
                    64,
                    63,
                    73,
                    74,
                    65,
                    64,
                    74,
                    75,
                    66,
                    65,
                    75,
                    76,
                    67,
                    66,
                    76,
                    77,
                    68,
                    67,
                    77,
                    78,
                    69,
                    68,
                    78,
                    79,
                    60,
                    69,
                    79,
                    70,
                    71,
                    70,
                    0,
                    1,
                    72,
                    71,
                    1,
                    2,
                    73,
                    72,
                    2,
                    3,
                    74,
                    73,
                    3,
                    4,
                    75,
                    74,
                    4,
                    5,
                    76,
                    75,
                    5,
                    6,
                    77,
                    76,
                    6,
                    7,
                    78,
                    77,
                    7,
                    8,
                    79,
                    78,
                    8,
                    9,
                    70,
                    79,
                    9,
                    0,
                ],
                "u_array": [
                    0.0,
                    0.10000000149011612,
                    0.20000000298023224,
                    0.30000001192092896,
                    0.4000000059604645,
                    0.5,
                    0.6000000238418579,
                    0.7000000476837158,
                    0.8000000715255737,
                    0.9000000953674316,
                    1.0000001192092896,
                    0.0,
                    0.10000000149011612,
                    0.20000000298023224,
                    0.30000001192092896,
                    0.4000000059604645,
                    0.5,
                    0.6000000238418579,
                    0.7000000476837158,
                    0.8000000715255737,
                    0.9000000953674316,
                    1.0000001192092896,
                    0.0,
                    0.10000000149011612,
                    0.20000000298023224,
                    0.30000001192092896,
                    0.4000000059604645,
                    0.5,
                    0.6000000238418579,
                    0.7000000476837158,
                    0.8000000715255737,
                    0.9000000953674316,
                    1.0000001192092896,
                    0.0,
                    0.10000000149011612,
                    0.20000000298023224,
                    0.30000001192092896,
                    0.4000000059604645,
                    0.5,
                    0.6000000238418579,
                    0.7000000476837158,
                    0.8000000715255737,
                    0.9000000953674316,
                    1.0000001192092896,
                    0.0,
                    0.10000000149011612,
                    0.20000000298023224,
                    0.30000001192092896,
                    0.4000000059604645,
                    0.5,
                    0.6000000238418579,
                    0.7000000476837158,
                    0.8000000715255737,
                    0.9000000953674316,
                    1.0000001192092896,
                    0.0,
                    0.10000000149011612,
                    0.20000000298023224,
                    0.30000001192092896,
                    0.4000000059604645,
                    0.5,
                    0.6000000238418579,
                    0.7000000476837158,
                    0.8000000715255737,
                    0.9000000953674316,
                    1.0000001192092896,
                    0.0,
                    0.10000000149011612,
                    0.20000000298023224,
                    0.30000001192092896,
                    0.4000000059604645,
                    0.5,
                    0.6000000238418579,
                    0.7000000476837158,
                    0.8000000715255737,
                    0.9000000953674316,
                    1.0000001192092896,
                    0.0,
                    0.10000000149011612,
                    0.20000000298023224,
                    0.30000001192092896,
                    0.4000000059604645,
                    0.5,
                    0.6000000238418579,
                    0.7000000476837158,
                    0.8000000715255737,
                    0.9000000953674316,
                    1.0000001192092896,
                    0.0,
                    0.10000000149011612,
                    0.20000000298023224,
                    0.30000001192092896,
                    0.4000000059604645,
                    0.5,
                    0.6000000238418579,
                    0.7000000476837158,
                    0.8000000715255737,
                    0.9000000953674316,
                    1.0000001192092896,
                ],
                "v_array": [
                    1.0,
                    1.0,
                    1.0,
                    1.0,
                    1.0,
                    1.0,
                    1.0,
                    1.0,
                    1.0,
                    1.0,
                    1.0,
                    0.875,
                    0.875,
                    0.875,
                    0.875,
                    0.875,
                    0.875,
                    0.875,
                    0.875,
                    0.875,
                    0.875,
                    0.875,
                    0.75,
                    0.75,
                    0.75,
                    0.75,
                    0.75,
                    0.75,
                    0.75,
                    0.75,
                    0.75,
                    0.75,
                    0.75,
                    0.625,
                    0.625,
                    0.625,
                    0.625,
                    0.625,
                    0.625,
                    0.625,
                    0.625,
                    0.625,
                    0.625,
                    0.625,
                    0.5,
                    0.5,
                    0.5,
                    0.5,
                    0.5,
                    0.5,
                    0.5,
                    0.5,
                    0.5,
                    0.5,
                    0.5,
                    0.375,
                    0.375,
                    0.375,
                    0.375,
                    0.375,
                    0.375,
                    0.375,
                    0.375,
                    0.375,
                    0.375,
                    0.375,
                    0.25,
                    0.25,
                    0.25,
                    0.25,
                    0.25,
                    0.25,
                    0.25,
                    0.25,
                    0.25,
                    0.25,
                    0.25,
                    0.125,
                    0.125,
                    0.125,
                    0.125,
                    0.125,
                    0.125,
                    0.125,
                    0.125,
                    0.125,
                    0.125,
                    0.125,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                "uv_counts": [
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                    4,
                ],
                "uv_ids": [
                    1,
                    0,
                    11,
                    12,
                    2,
                    1,
                    12,
                    13,
                    3,
                    2,
                    13,
                    14,
                    4,
                    3,
                    14,
                    15,
                    5,
                    4,
                    15,
                    16,
                    6,
                    5,
                    16,
                    17,
                    7,
                    6,
                    17,
                    18,
                    8,
                    7,
                    18,
                    19,
                    9,
                    8,
                    19,
                    20,
                    10,
                    9,
                    20,
                    21,
                    12,
                    11,
                    22,
                    23,
                    13,
                    12,
                    23,
                    24,
                    14,
                    13,
                    24,
                    25,
                    15,
                    14,
                    25,
                    26,
                    16,
                    15,
                    26,
                    27,
                    17,
                    16,
                    27,
                    28,
                    18,
                    17,
                    28,
                    29,
                    19,
                    18,
                    29,
                    30,
                    20,
                    19,
                    30,
                    31,
                    21,
                    20,
                    31,
                    32,
                    23,
                    22,
                    33,
                    34,
                    24,
                    23,
                    34,
                    35,
                    25,
                    24,
                    35,
                    36,
                    26,
                    25,
                    36,
                    37,
                    27,
                    26,
                    37,
                    38,
                    28,
                    27,
                    38,
                    39,
                    29,
                    28,
                    39,
                    40,
                    30,
                    29,
                    40,
                    41,
                    31,
                    30,
                    41,
                    42,
                    32,
                    31,
                    42,
                    43,
                    34,
                    33,
                    44,
                    45,
                    35,
                    34,
                    45,
                    46,
                    36,
                    35,
                    46,
                    47,
                    37,
                    36,
                    47,
                    48,
                    38,
                    37,
                    48,
                    49,
                    39,
                    38,
                    49,
                    50,
                    40,
                    39,
                    50,
                    51,
                    41,
                    40,
                    51,
                    52,
                    42,
                    41,
                    52,
                    53,
                    43,
                    42,
                    53,
                    54,
                    45,
                    44,
                    55,
                    56,
                    46,
                    45,
                    56,
                    57,
                    47,
                    46,
                    57,
                    58,
                    48,
                    47,
                    58,
                    59,
                    49,
                    48,
                    59,
                    60,
                    50,
                    49,
                    60,
                    61,
                    51,
                    50,
                    61,
                    62,
                    52,
                    51,
                    62,
                    63,
                    53,
                    52,
                    63,
                    64,
                    54,
                    53,
                    64,
                    65,
                    56,
                    55,
                    66,
                    67,
                    57,
                    56,
                    67,
                    68,
                    58,
                    57,
                    68,
                    69,
                    59,
                    58,
                    69,
                    70,
                    60,
                    59,
                    70,
                    71,
                    61,
                    60,
                    71,
                    72,
                    62,
                    61,
                    72,
                    73,
                    63,
                    62,
                    73,
                    74,
                    64,
                    63,
                    74,
                    75,
                    65,
                    64,
                    75,
                    76,
                    67,
                    66,
                    77,
                    78,
                    68,
                    67,
                    78,
                    79,
                    69,
                    68,
                    79,
                    80,
                    70,
                    69,
                    80,
                    81,
                    71,
                    70,
                    81,
                    82,
                    72,
                    71,
                    82,
                    83,
                    73,
                    72,
                    83,
                    84,
                    74,
                    73,
                    84,
                    85,
                    75,
                    74,
                    85,
                    86,
                    76,
                    75,
                    86,
                    87,
                    78,
                    77,
                    88,
                    89,
                    79,
                    78,
                    89,
                    90,
                    80,
                    79,
                    90,
                    91,
                    81,
                    80,
                    91,
                    92,
                    82,
                    81,
                    92,
                    93,
                    83,
                    82,
                    93,
                    94,
                    84,
                    83,
                    94,
                    95,
                    85,
                    84,
                    95,
                    96,
                    86,
                    85,
                    96,
                    97,
                    87,
                    86,
                    97,
                    98,
                ],
            },
        },
    ),
]

description = """## chain01
---

chain(쇠사슬) 컴포넌트 입니다. 

#### input
> 두 가지 레이어의 컨트롤러 갯수와 쇠사슬의 갯수를 입력받습니다.

#### Guide
> master layer, sub layer 컨트롤러를 조정 할 수 있습니다.

#### Settings
> chain 의 크기, 굵기, 간격 등 을 조절 할 수 있습니다.

#### Rig
> stretch 될 때 각 사슬이 떨어지지 않도록 스케일을 조정 할 수 있습니다.  
> squash 될 때 균등하게 줄어들지, 시작지점에 쌓일지, 마지막지점에 쌓일지 정할수있습니다.  
> nhair 를 사용한 dynamic 설정도 포함됩니다.  
> dynamic manager 와 같이 사용할 수 있습니다.
"""

# endregion


def driver_surface(parent, master_name, sub_name, master_layer_count, sub_layer_count):
    ins = NurbsCurve()
    if master_layer_count == 2:
        degree = 1
    elif master_layer_count == 3:
        degree = 2
    else:
        degree = 3
    curve0 = ins.create(
        None,
        name="tempCrv0",
        degree=degree,
        point=[(-0.2, i, 0) for i in range(master_layer_count)],
    )
    curve1 = ins.create(
        None,
        name="tempCrv2",
        degree=degree,
        point=[(0.2, i, 0) for i in range(master_layer_count)],
    )
    master_driver_surf = cmds.loft(
        curve0,
        curve1,
        name=master_name,
        constructionHistory=False,
        uniform=1,
        close=0,
        autoReverse=0,
        degree=1,
        sectionSpans=1,
        polygon=0,
        reverseSurfaceNormals=True,
    )[0]
    master_driver_surf = cmds.rebuildSurface(
        constructionHistory=0,
        replaceOriginal=1,
        rebuildType=0,
        endKnots=1,
        keepRange=0,
        keepControlPoints=0,
        keepCorners=0,
        spansU=0,
        degreeU=degree,
        spansV=0,
        degreeV=1,
        tolerance=0,
        fitRebuild=0,
        direction=2,
    )[0]
    cmds.delete([curve0, curve1])

    curve0 = ins.create(
        None,
        name="tempCrv0",
        degree=3,
        point=[(-0.2, i, 0) for i in range(sub_layer_count)],
    )
    curve1 = ins.create(
        None,
        name="tempCrv1",
        degree=3,
        point=[(0.2, i, 0) for i in range(sub_layer_count)],
    )
    sub_driver_surf = cmds.loft(
        curve0,
        curve1,
        name=sub_name,
        constructionHistory=False,
        uniform=1,
        close=0,
        autoReverse=0,
        degree=3,
        sectionSpans=1,
        polygon=0,
        reverseSurfaceNormals=True,
    )[0]
    sub_driver_surf = cmds.rebuildSurface(
        constructionHistory=0,
        replaceOriginal=1,
        rebuildType=0,
        endKnots=1,
        keepRange=0,
        keepControlPoints=0,
        keepCorners=0,
        spansU=0,
        degreeU=0,
        spansV=0,
        degreeV=1,
        tolerance=0,
        fitRebuild=0,
        direction=2,
    )[0]
    cmds.delete([curve0, curve1])
    master_driver_surf, sub_driver_surf = cmds.parent(
        [master_driver_surf, sub_driver_surf], parent
    )
    return master_driver_surf, sub_driver_surf


def sim_mesh(count):
    sim_meshes0 = []
    sim_meshes1 = []
    for i in range(count):
        if i % 2 == 0:
            sim_meshes0.append(cmds.polyCube(constructionHistory=0)[0])
        else:
            sim_meshes1.append(cmds.polyCube(constructionHistory=0)[0])

    sim_mesh0 = cmds.polyUnite(sim_meshes0, constructionHistory=0)[0]
    sim_mesh1 = cmds.polyUnite(sim_meshes1, constructionHistory=0)[0]
    return sim_mesh0, sim_mesh1


class Rig(component.Rig):

    def input_data(self):
        dialog = QtWidgets.QDialog()
        dialog.setWindowTitle("Controller Count")
        master_label = QtWidgets.QLabel("Master layer Controller Count : ")
        master_line_edit = QtWidgets.QLineEdit()
        sub_label = QtWidgets.QLabel("Sub layer Controller Count : ")
        sub_line_edit = QtWidgets.QLineEdit()
        count_label = QtWidgets.QLabel("Chain Count : ")
        count_line_edit = QtWidgets.QLineEdit()
        ok_btn = QtWidgets.QPushButton("Ok")
        ok_btn.clicked.connect(dialog.accept)
        cancel_btn = QtWidgets.QPushButton("Cancel")
        cancel_btn.clicked.connect(dialog.reject)

        layout0 = QtWidgets.QVBoxLayout(dialog)
        layout1 = QtWidgets.QHBoxLayout()
        layout1.addWidget(master_label)
        layout1.addWidget(master_line_edit)
        layout2 = QtWidgets.QHBoxLayout()
        layout2.addWidget(sub_label)
        layout2.addWidget(sub_line_edit)
        layout3 = QtWidgets.QHBoxLayout()
        layout3.addWidget(count_label)
        layout3.addWidget(count_line_edit)
        layout4 = QtWidgets.QHBoxLayout()
        layout4.addWidget(ok_btn)
        layout4.addWidget(cancel_btn)
        layout0.addLayout(layout1)
        layout0.addLayout(layout2)
        layout0.addLayout(layout3)
        layout0.addLayout(layout4)

        result = dialog.exec()
        try:
            master_value = int(master_line_edit.text())
            if master_value < 2:
                return
            sub_value = int(sub_line_edit.text())
            if sub_value < 4:
                return
            count_value = int(count_line_edit.text())
            if count_value < 2:
                return
            self["master_layer_count"]["value"] = master_value
            self["sub_layer_count"]["value"] = sub_value
            self["chain_count"]["value"] = count_value
            self["sub_driver_u_values"]["value"] = [
                v / (sub_value - 1) for v in range(sub_value)
            ]

            self["guide_matrix"]["value"] = []
            self["npo_matrix"]["value"] = []
            for _ in range(1 + (master_value * 2) + sub_value):
                self["guide_matrix"]["value"].append(
                    [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1]
                )
                self["guide_mirror_type"]["value"].append(1)
            for _ in range(master_value):
                self["npo_matrix"]["value"].append(
                    [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1]
                )
            self["sub_driver_matrix"]["value"] = []
            for _ in range(sub_value):
                self["sub_driver_matrix"]["value"].append(
                    [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1]
                )

            self["main_ik_rotate_x"]["value"] = [0 for _ in range(count_value)]
            self["main_ik_rotate_y"]["value"] = [0 for _ in range(count_value)]
            self["main_ik_rotate_z"]["value"] = [0 for _ in range(count_value)]
            self["up_ik_rotate_x"]["value"] = [0 for _ in range(count_value)]
            self["up_ik_rotate_y"]["value"] = [0 for _ in range(count_value)]
            self["up_ik_rotate_z"]["value"] = [0 for _ in range(count_value)]
            self["dyn_ik_rotate_x"]["value"] = [0 for _ in range(count_value)]
            self["dyn_ik_rotate_y"]["value"] = [0 for _ in range(count_value)]
            self["dyn_ik_rotate_z"]["value"] = [0 for _ in range(count_value)]
            self["initialize_output_matrix"]["value"] = [
                list(ORIGINMATRIX) for _ in range(count_value)
            ]
            self["initialize_output_inverse_matrix"]["value"] = [
                list(ORIGINMATRIX) for _ in range(count_value)
            ]
        except:
            return False
        return result

    def __init__(self):
        super().__init__(DATA)

    def populate_controller(self):
        if not self["controller"]:
            self.add_controller(description="host", parent_controllers=[])
            parent_controller = [(self.identifier, "host")]
            for i in range(self["master_layer_count"]["value"]):
                self.add_controller(
                    description=f"masterLayer{i}", parent_controllers=parent_controller
                )
                parent_controller = [(self.identifier, f"masterLayer{i}")]

            for i in range(self["sub_layer_count"]["value"]):
                self.add_controller(
                    description=f"subLayer{i}", parent_controllers=parent_controller
                )
                parent_controller = [(self.identifier, f"subLayer{i}")]

            for i in range(self["chain_count"]["value"]):
                self.add_controller(description=i, parent_controllers=parent_controller)
                parent_controller = [(self.identifier, i)]

    def populate_output(self):
        if not self["output"]:
            for i in range(self["chain_count"]["value"]):
                self.add_output(description=i, extension=Name.output_extension)

    def populate_output_joint(self):
        if not self["output_joint"]:
            parent = None
            for i in range(self["chain_count"]["value"]):
                self.add_output_joint(parent_description=parent, description=i)
                parent = i

    # region RIG
    @build_log(logging.INFO)
    def rig(self):
        super().rig(description=description)

        name, side, index = self.identifier

        # controller
        host_npo, host_ctl = self["controller"][0].create(
            parent=self.rig_root,
            shape=(
                self["controller"][0]["shape"]
                if "shape" in self["controller"][0]
                else "host"
            ),
            color=12,
            host=True,
        )
        cmds.setAttr(f"{host_ctl}.tx", lock=True, keyable=False)
        cmds.setAttr(f"{host_ctl}.ty", lock=True, keyable=False)
        cmds.setAttr(f"{host_ctl}.tz", lock=True, keyable=False)
        cmds.setAttr(f"{host_ctl}.rx", lock=True, keyable=False)
        cmds.setAttr(f"{host_ctl}.ry", lock=True, keyable=False)
        cmds.setAttr(f"{host_ctl}.rz", lock=True, keyable=False)
        cmds.setAttr(f"{host_ctl}.rotateOrder", channelBox=False)
        cmds.addAttr(
            host_ctl,
            longName="_stretch_squash",
            attributeType="enum",
            enumName="____________",
            keyable=False,
        )
        cmds.setAttr(f"{host_ctl}._stretch_squash", channelBox=True)
        cmds.addAttr(
            host_ctl,
            longName="enable_stretch",
            attributeType="float",
            minValue=0,
            maxValue=1,
            defaultValue=0,
            keyable=True,
        )
        cmds.addAttr(
            host_ctl,
            longName="enable_squash",
            attributeType="float",
            minValue=0,
            maxValue=1,
            defaultValue=0,
            keyable=True,
        )
        cmds.addAttr(
            host_ctl,
            longName="enable_scale",
            attributeType="float",
            minValue=0,
            maxValue=1,
            defaultValue=1,
            keyable=True,
        )
        cmds.addAttr(
            host_ctl,
            longName="squash_method",
            attributeType="enum",
            enumName="uniform:startStack:endStack",
            keyable=True,
        )
        cmds.addAttr(
            host_ctl,
            longName="_volume",
            attributeType="enum",
            enumName="____________",
            keyable=False,
        )
        cmds.setAttr(f"{host_ctl}._volume", channelBox=True)
        cmds.addAttr(
            host_ctl,
            longName="volume_high_position",
            attributeType="float",
            minValue=0,
            maxValue=1,
            defaultValue=1,
            keyable=True,
        )
        cmds.addAttr(
            host_ctl,
            longName="volume_high_value",
            attributeType="float",
            minValue=0,
            maxValue=10,
            defaultValue=0,
            keyable=True,
        )
        cmds.addAttr(
            host_ctl,
            longName="volume_mid_position",
            attributeType="float",
            minValue=0,
            maxValue=1,
            defaultValue=0.5,
            keyable=True,
        )
        cmds.addAttr(
            host_ctl,
            longName="volume_mid_value",
            attributeType="float",
            minValue=-1,
            maxValue=10,
            defaultValue=0,
            keyable=True,
        )
        cmds.addAttr(
            host_ctl,
            longName="volume_low_position",
            attributeType="float",
            minValue=0,
            maxValue=1,
            defaultValue=0,
            keyable=True,
        )
        cmds.addAttr(
            host_ctl,
            longName="volume_low_value",
            attributeType="float",
            minValue=0,
            maxValue=10,
            defaultValue=0,
            keyable=True,
        )
        cmds.addAttr(
            host_ctl,
            longName="_visibility",
            attributeType="enum",
            enumName="____________",
            keyable=False,
        )
        cmds.setAttr(f"{host_ctl}._visibility", channelBox=True)
        cmds.addAttr(
            host_ctl,
            longName="master_surface_visibility",
            attributeType="enum",
            enumName="off:on",
            defaultValue=0,
            keyable=True,
        )
        cmds.addAttr(
            host_ctl,
            longName="sub_ctl_visibility",
            attributeType="enum",
            enumName="off:on",
            defaultValue=0,
            keyable=True,
        )
        cmds.addAttr(
            host_ctl,
            longName="sub_surface_visibility",
            attributeType="enum",
            enumName="off:on",
            defaultValue=0,
            keyable=True,
        )
        cmds.addAttr(
            host_ctl,
            longName="tweak_ctls_visibility",
            attributeType="enum",
            enumName="off:on",
            defaultValue=0,
            keyable=True,
        )
        cmds.addAttr(
            host_ctl,
            longName="initial_chain_visibility",
            attributeType="enum",
            enumName="off:on",
            defaultValue=0,
            keyable=True,
        )
        cmds.addAttr(
            host_ctl,
            longName="_dynamic",
            attributeType="enum",
            enumName="____________",
            keyable=False,
        )
        cmds.setAttr(f"{host_ctl}._dynamic", channelBox=True)
        cmds.addAttr(
            host_ctl,
            longName="enable_dynamic",
            attributeType="long",
            minValue=0,
            maxValue=1,
            defaultValue=0,
            keyable=True,
        )
        cmds.addAttr(
            host_ctl,
            longName="space_scale",
            attributeType="float",
            minValue=0,
            maxValue=2,
            defaultValue=1,
            keyable=True,
        )
        cmds.addAttr(
            host_ctl,
            longName="point_lock",
            attributeType="enum",
            enumName="no_attach:base:tip:both",
            defaultValue=3,
            keyable=True,
        )
        cmds.addAttr(
            host_ctl,
            longName="bend_resistance",
            attributeType="float",
            minValue=0,
            maxValue=10,
            defaultValue=0,
            keyable=True,
        )
        cmds.addAttr(
            host_ctl,
            longName="damp",
            attributeType="float",
            minValue=0,
            maxValue=10,
            defaultValue=0.1,
            keyable=True,
        )
        cmds.addAttr(
            host_ctl,
            longName="extra_bend_links",
            attributeType="long",
            minValue=0,
            defaultValue=0,
            keyable=True,
        )

        if "value" not in self["master_layer_surface"]:
            master_surf, sub_surf = driver_surface(
                self.rig_root,
                master_name=Name.create(
                    Name.controller_name_convention,
                    name=name,
                    side=side,
                    index=index,
                    description="master",
                    extension="surf",
                ),
                sub_name=Name.create(
                    Name.controller_name_convention,
                    name=name,
                    side=side,
                    index=index,
                    description="sub",
                    extension="surf",
                ),
                master_layer_count=self["master_layer_count"]["value"],
                sub_layer_count=self["sub_layer_count"]["value"],
            )
            cmds.connectAttr(
                f"{master_surf}.worldSpace[0]", f"{self.rig_root}.master_layer_surface"
            )
            cmds.disconnectAttr(
                f"{master_surf}.worldSpace[0]", f"{self.rig_root}.master_layer_surface"
            )
            cmds.connectAttr(
                f"{sub_surf}.worldSpace[0]", f"{self.rig_root}.sub_layer_surface"
            )
            cmds.disconnectAttr(
                f"{sub_surf}.worldSpace[0]", f"{self.rig_root}.sub_layer_surface"
            )
        else:
            ins = NurbsSurface(data=self["master_layer_surface"]["value"])
            master_surf = ins.create_from_data()
            master_surf = cmds.rename(
                master_surf,
                Name.create(
                    Name.controller_name_convention,
                    name=name,
                    side=side,
                    index=index,
                    description="master",
                    extension="surf",
                ),
            )
            master_surf = cmds.parent(master_surf, self.rig_root)[0]
            ins = NurbsSurface(data=self["sub_layer_surface"]["value"])
            sub_surf = ins.create_from_data()
            sub_surf = cmds.rename(
                sub_surf,
                Name.create(
                    Name.controller_name_convention,
                    name=name,
                    side=side,
                    index=index,
                    description="sub",
                    extension="surf",
                ),
            )
            sub_surf = cmds.parent(sub_surf, self.rig_root)[0]
        cmds.hide(master_surf, sub_surf)

        master_guide_surface = cmds.duplicate(
            sub_surf,
            name=Name.create(
                Name.controller_name_convention,
                name=name,
                side=side,
                index=index,
                description="master",
                extension="guideSurf",
            ),
        )[0]
        cmds.connectAttr(
            f"{host_ctl}.master_surface_visibility",
            f"{master_guide_surface}.visibility",
        )
        cmds.setAttr(f"{master_guide_surface}.overrideEnabled", 1)
        cmds.setAttr(f"{master_guide_surface}.overrideDisplayType", 2)
        sub_guide_surface = cmds.duplicate(
            sub_surf,
            name=Name.create(
                Name.controller_name_convention,
                name=name,
                side=side,
                index=index,
                description="sub",
                extension="guideSurf",
            ),
        )[0]
        cmds.connectAttr(
            f"{host_ctl}.sub_surface_visibility",
            f"{sub_guide_surface}.visibility",
        )
        cmds.setAttr(f"{sub_guide_surface}.overrideEnabled", 1)
        cmds.setAttr(f"{sub_guide_surface}.overrideDisplayType", 2)

        # controller
        c = 1
        master_driver_joints = []
        for i in range(self["master_layer_count"]["value"]):
            npo, ctl = self["controller"][c].create(
                parent=self.rig_root,
                shape=(
                    self["controller"][c]["shape"]
                    if "shape" in self["controller"][c]
                    else "cube"
                ),
                color=12,
                npo_matrix_index=c - 1,
            )
            ins = Joint(
                ctl,
                name=name,
                side=side,
                index=index,
                description=f"masterLayer{i}",
                extension=Name.joint_extension,
                m=cmds.xform(ctl, query=True, matrix=True, worldSpace=True),
            )
            jnt = ins.create()
            master_driver_joints.append(jnt)
            c += 1
        pin = cmds.createNode("uvPin")
        cmds.setAttr(f"{pin}.relativeSpaceMode", 1)
        cmds.connectAttr(f"{master_surf}Shape.worldSpace[0]", f"{pin}.deformedGeometry")
        sub_driver_joints = []
        for i in range(self["sub_layer_count"]["value"]):
            npo, ctl = self["controller"][c].create(
                parent=self.rig_root,
                shape=(
                    self["controller"][c]["shape"]
                    if "shape" in self["controller"][c]
                    else "square"
                ),
                color=12,
            )
            cmds.connectAttr(f"{host_ctl}.sub_ctl_visibility", f"{npo}.v")
            cmds.connectAttr(
                f"{self.rig_root}.sub_driver_u_values[{i}]",
                f"{pin}.coordinate[{i}].coordinateU",
            )
            cmds.setAttr(f"{pin}.coordinate[{i}].coordinateV", 0.5)

            pick_m = cmds.createNode("pickMatrix")
            cmds.connectAttr(f"{pin}.outputMatrix[{i}]", f"{pick_m}.inputMatrix")
            cmds.setAttr(f"{pick_m}.useScale", 0)
            cmds.setAttr(f"{pick_m}.useShear", 0)
            cmds.connectAttr(f"{pick_m}.outputMatrix", f"{npo}.offsetParentMatrix")

            decom_m = cmds.createNode("decomposeMatrix")
            cmds.connectAttr(
                f"{self.rig_root}.sub_driver_matrix[{i}]", f"{decom_m}.inputMatrix"
            )
            cmds.connectAttr(f"{decom_m}.outputTranslate", f"{npo}.t")
            cmds.connectAttr(f"{decom_m}.outputRotate", f"{npo}.r")

            ins = Joint(
                ctl,
                name=name,
                side=side,
                index=index,
                description=f"subLayer{i}",
                extension=Name.joint_extension,
                m=cmds.xform(ctl, query=True, matrix=True, worldSpace=True),
            )
            jnt = ins.create()
            sub_driver_joints.append(jnt)
            c += 1

        tweak_controllers = []
        for i in range(self["chain_count"]["value"]):
            npo, ctl = self["controller"][c].create(
                parent=self.rig_root,
                shape=(
                    self["controller"][c]["shape"]
                    if "shape" in self["controller"][c]
                    else "square"
                ),
                color=12,
            )
            cmds.connectAttr(f"{host_ctl}.tweak_ctls_visibility", f"{npo}.v")
            tweak_controllers.append(ctl)
            c += 1

        master_sc = rigkit.bind_skincluster(
            master_surf, master_driver_joints, f"{master_surf}0_sc"
        )
        cmds.sets(master_sc, edit=True, addElement=component.DEFORMER_WEIGHTS_SETS)
        for i in range(self["master_layer_count"]["value"]):
            cmds.skinPercent(
                master_sc,
                f"{master_surf}.cv[{i}][*]",
                transformValue=[master_driver_joints[i], 1],
            )
            inverse_m = cmds.createNode("inverseMatrix")
            cmds.connectAttr(
                f"{self.rig_root}.npo_matrix[{i}]", f"{inverse_m}.inputMatrix"
            )
            cmds.connectAttr(
                f"{inverse_m}.outputMatrix", f"{master_sc}.bindPreMatrix[{i}]"
            )
        cmds.connectAttr(
            f"{self.rig_root}.master_layer_surface", f"{master_surf}ShapeOrig.create"
        )

        ins = Transform(
            parent=self.rig_root,
            name=name,
            side=side,
            index=index,
            description="ribbon",
            extension="grp",
            m=ORIGINMATRIX,
        )
        ribbon_grp = ins.create()
        cmds.hide(ribbon_grp)

        parent = ribbon_grp
        main_ik_joints = []
        negate_value = -1 if side == 2 else 1
        for i in range(self["chain_count"]["value"] + 1):
            ins = Joint(
                parent,
                name=name,
                side=side,
                index=index,
                description=f"mainIk{i}",
                extension=Name.joint_extension,
                m=[1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, i * negate_value, 0, 0, 1],
            )
            jnt = ins.create()
            main_ik_joints.append(jnt)
            parent = jnt
        parent = ribbon_grp
        up_ik_joints = []
        for i in range(self["chain_count"]["value"] + 1):
            ins = Joint(
                parent,
                name=name,
                side=side,
                index=index,
                description=f"upIk{i}",
                extension=Name.joint_extension,
                m=[1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, i * negate_value, 0, 0, 1],
            )
            jnt = ins.create()
            up_ik_joints.append(jnt)
            parent = jnt
        parent = ribbon_grp
        dyn_ik_joints = []
        for i in range(self["chain_count"]["value"] + 1):
            ins = Joint(
                parent,
                name=name,
                side=side,
                index=index,
                description=f"dynIk{i}",
                extension=Name.joint_extension,
                m=[1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, i * negate_value, 0, 0, 1],
            )
            jnt = ins.create()
            dyn_ik_joints.append(jnt)
            parent = jnt

        condition = cmds.createNode("condition")
        cmds.connectAttr(f"{self.rig_root}.side", f"{condition}.firstTerm")
        cmds.setAttr(f"{condition}.secondTerm", 2)
        cmds.setAttr(f"{condition}.colorIfTrueR", -1)
        cmds.setAttr(f"{condition}.colorIfFalseR", 1)

        ribbon_surface, ribbon_outputs, nucleus, hair_system, follicles = (
            rigkit.ribbon_chain_spline_ik(
                ribbon_grp,
                driver_joints=sub_driver_joints,
                driver_inverse_plugs=[
                    f"{self.rig_root}.sub_driver_inverse_matrix[{i}]"
                    for i in range(self["sub_layer_count"]["value"])
                ],
                surface=sub_surf,
                main_ik_joints=main_ik_joints,
                up_ik_joints=up_ik_joints,
                dyn_ik_joints=dyn_ik_joints,
                stretch_attr=f"{host_ctl}.enable_stretch",
                squash_attr=f"{host_ctl}.enable_squash",
                squash_pin_method_attr=f"{host_ctl}.squash_method",
                scale_attr=f"{host_ctl}.enable_scale",
                initial_chain_distance_attr=f"{self.rig_root}.chain_distance",
                volume_high_position_attr=f"{host_ctl}.volume_high_position",
                volume_high_value_attr=f"{host_ctl}.volume_high_value",
                volume_mid_position_attr=f"{host_ctl}.volume_mid_position",
                volume_mid_value_attr=f"{host_ctl}.volume_mid_value",
                volume_low_position_attr=f"{host_ctl}.volume_low_position",
                volume_low_value_attr=f"{host_ctl}.volume_low_value",
                dynamic_enable_attr=f"{host_ctl}.enable_dynamic",
                negate_plug=f"{condition}.outColorR",
                secondary_axis=(0, 1, 0),
            )
        )
        cmds.connectAttr(f"{host_ctl}.enable_dynamic", f"{nucleus}.enable")
        cmds.connectAttr(f"{host_ctl}.space_scale", f"{nucleus}.spaceScale")
        cmds.connectAttr(f"{host_ctl}.bend_resistance", f"{hair_system}.bendResistance")
        cmds.connectAttr(f"{host_ctl}.damp", f"{hair_system}.damp")
        cmds.connectAttr(f"{host_ctl}.point_lock", f"{follicles[0]}.pointLock")
        cmds.connectAttr(
            f"{host_ctl}.extra_bend_links", f"{hair_system}.extraBendLinks"
        )
        divide = cmds.createNode("divide")
        cmds.connectAttr(f"{self.rig_root}.scaled_width", f"{divide}.input1")
        cmds.setAttr(f"{divide}.input2", 2)
        pma = cmds.createNode("plusMinusAverage")
        cmds.connectAttr(f"{divide}.output", f"{pma}.input1D[0]")
        cmds.connectAttr(f"{self.rig_root}.scaled_radius", f"{pma}.input1D[1]")
        cmds.connectAttr(f"{pma}.output1D", f"{hair_system}.collideWidthOffset")
        cmds.connectAttr(
            f"{self.rig_root}.sub_layer_surface", f"{ribbon_surface}ShapeOrig.create"
        )
        cmds.connectAttr(
            f"{master_surf}Shape.worldSpace[0]", f"{master_guide_surface}Shape.create"
        )
        cmds.connectAttr(
            f"{ribbon_surface}Shape.worldSpace[0]", f"{sub_guide_surface}Shape.create"
        )

        for i in range(self["chain_count"]["value"] + 1):
            jnt = main_ik_joints[i]
            cmds.connectAttr(
                f"{self.rig_root}.main_ik_rotate_x[{i}]", f"{jnt}.jointOrientX"
            )
            cmds.connectAttr(
                f"{self.rig_root}.main_ik_rotate_y[{i}]", f"{jnt}.jointOrientY"
            )
            cmds.connectAttr(
                f"{self.rig_root}.main_ik_rotate_z[{i}]", f"{jnt}.jointOrientZ"
            )
            jnt = up_ik_joints[i]
            cmds.connectAttr(
                f"{self.rig_root}.up_ik_rotate_x[{i}]", f"{jnt}.jointOrientX"
            )
            cmds.connectAttr(
                f"{self.rig_root}.up_ik_rotate_y[{i}]", f"{jnt}.jointOrientY"
            )
            cmds.connectAttr(
                f"{self.rig_root}.up_ik_rotate_z[{i}]", f"{jnt}.jointOrientZ"
            )
            jnt = dyn_ik_joints[i]
            cmds.connectAttr(
                f"{self.rig_root}.dyn_ik_rotate_x[{i}]", f"{jnt}.jointOrientX"
            )
            cmds.connectAttr(
                f"{self.rig_root}.dyn_ik_rotate_y[{i}]", f"{jnt}.jointOrientY"
            )
            cmds.connectAttr(
                f"{self.rig_root}.dyn_ik_rotate_z[{i}]", f"{jnt}.jointOrientZ"
            )

        sub_sc = cmds.findDeformers(sub_surf)[0]
        cmds.sets(sub_sc, edit=True, addElement=component.DEFORMER_WEIGHTS_SETS)
        for i in range(self["sub_layer_count"]["value"]):
            cmds.skinPercent(
                sub_sc,
                f"{sub_surf}.cv[{i}][*]",
                transformValue=[sub_driver_joints[i], 1],
            )

        cmds.hide(master_driver_joints, sub_driver_joints)

        # output
        outputs = []
        for i, ribbon_output in enumerate(ribbon_outputs):
            cmds.connectAttr(
                f"{ribbon_output}.dagLocalMatrix",
                f"{tweak_controllers[i]}.offsetParentMatrix",
            )
            ins = Joint(
                self.rig_root,
                name=name,
                side=side,
                index=index,
                description=i,
                extension=Name.output_extension,
                m=ORIGINMATRIX,
            )
            output = ins.create()
            self["output"][i].connect(tweak_controllers[i])
            cmds.setAttr(f"{output}.drawStyle", 2)
            outputs.append(output)

        ins = Mesh(data=self["chain_mesh"]["value"])
        mesh = ins.create_from_data()
        cmds.hide(mesh)
        for i, output in enumerate(outputs):
            copy_shape = cmds.duplicate(
                mesh,
                name=Name.create(
                    Name.controller_name_convention,
                    name=name,
                    side=side,
                    index=index,
                    description=f"chain{i}",
                    extension="mesh",
                ),
            )[0]
            copy_shape = cmds.parent(copy_shape, output)[0]
            cmds.setAttr(f"{copy_shape}.t", 0, 0, 0)
            cmds.setAttr(f"{copy_shape}.r", *((90, 0, 0) if i % 2 == 1 else (0, 0, 0)))
            cmds.setAttr(f"{copy_shape}.s", 1, 1, 1)
            cmds.connectAttr(
                f"{host_ctl}.initial_chain_visibility", f"{copy_shape}.visibility"
            )
            cmds.setAttr(f"{copy_shape}.overrideEnabled", 1)
            cmds.setAttr(f"{copy_shape}.overrideDisplayType", 2)
            cmds.connectAttr(f"{self.rig_root}.chain_mesh", f"{copy_shape}.inMesh")
        cmds.delete(mesh)

        # output joint
        if self["create_output_joint"]["value"]:
            for i in range(len(ribbon_outputs)):
                self["output_joint"][i].create()

    # endregion

    # region GUIDE
    @build_log(logging.INFO)
    def guide(self):
        super().guide(description=description)

        name, side, index = self.identifier
        if not cmds.pluginInfo("nearestPointOnMesh", query=True, loaded=True):
            cmds.loadPlugin("nearestPointOnMesh")

        condition = cmds.createNode("condition")
        cmds.setAttr(f"{condition}.operation", 0)
        cmds.connectAttr(f"{self.guide_root}.side", f"{condition}.firstTerm")
        cmds.setAttr(f"{condition}.secondTerm", 2)
        cmds.setAttr(f"{condition}.colorIfTrueR", -1)
        cmds.setAttr(f"{condition}.colorIfFalseR", 1)
        negate_plug = f"{condition}.outColorR"

        if round(cmds.getAttr(f"{self.guide_root}.sx"), 3) == 1.0:
            cmds.setAttr(
                f"{self.guide_root}.width",
                cmds.getAttr(f"{self.guide_root}.scaled_width"),
            )
            cmds.setAttr(
                f"{self.guide_root}.height",
                cmds.getAttr(f"{self.guide_root}.scaled_height"),
            )
            cmds.setAttr(
                f"{self.guide_root}.radius",
                cmds.getAttr(f"{self.guide_root}.scaled_radius"),
            )
            cmds.setAttr(
                f"{self.guide_root}.next_chain_offset",
                cmds.getAttr(f"{self.guide_root}.scaled_next_chain_offset"),
            )
        decom_m = cmds.createNode("decomposeMatrix")
        cmds.connectAttr(f"{self.guide_root}.worldMatrix[0]", f"{decom_m}.inputMatrix")

        multiply = cmds.createNode("multiply")
        cmds.connectAttr(f"{self.guide_root}.width", f"{multiply}.input[0]")
        cmds.connectAttr(f"{decom_m}.outputScaleX", f"{multiply}.input[1]")
        cmds.connectAttr(f"{multiply}.output", f"{self.guide_root}.scaled_width")
        multiply = cmds.createNode("multiply")
        cmds.connectAttr(f"{self.guide_root}.height", f"{multiply}.input[0]")
        cmds.connectAttr(f"{decom_m}.outputScaleX", f"{multiply}.input[1]")
        cmds.connectAttr(f"{multiply}.output", f"{self.guide_root}.scaled_height")
        multiply = cmds.createNode("multiply")
        cmds.connectAttr(f"{self.guide_root}.radius", f"{multiply}.input[0]")
        cmds.connectAttr(f"{decom_m}.outputScaleX", f"{multiply}.input[1]")
        cmds.connectAttr(f"{multiply}.output", f"{self.guide_root}.scaled_radius")
        multiply = cmds.createNode("multiply")
        cmds.connectAttr(f"{self.guide_root}.next_chain_offset", f"{multiply}.input[0]")
        cmds.connectAttr(f"{decom_m}.outputScaleX", f"{multiply}.input[1]")
        cmds.connectAttr(
            f"{multiply}.output", f"{self.guide_root}.scaled_next_chain_offset"
        )

        mesh, cube = cmds.polyCube(
            name=Name.create(
                Name.controller_name_convention,
                name=name,
                side=side,
                index=index,
                description="bevel",
                extension="meshGuide",
            )
        )
        cmds.setAttr(f"{cube}.heightBaseline", -1)
        cmds.setAttr(f"{cube}.axis", 1, 0, 0)
        cmds.connectAttr(f"{self.guide_root}.width", f"{cube}.width")
        cmds.connectAttr(f"{self.guide_root}.height", f"{cube}.height")
        cmds.select([f"{mesh}.f[0]", f"{mesh}.f[2]"])
        cmds.delete(constructionHistory=False)
        bevel = cmds.polyBevel3(mesh)[0]
        cmds.setAttr(f"{bevel}.offsetAsFraction", 1)
        cmds.connectAttr(f"{self.guide_root}.bevel", f"{bevel}.fraction")
        cmds.setAttr(f"{bevel}.segments", 2)
        cmds.select(f"{mesh}.e[8]")
        mel.eval("SelectEdgeRingSp;")
        cmds.polyConnectComponents(
            constructionHistory=True, insertWithEdgeFlow=0, adjustEdgeFlow=1
        )
        cmds.select(f"{mesh}.e[48:59]")
        curve, edge_to_cruve = cmds.polyToCurve(
            degree=1,
            name=Name.create(
                Name.controller_name_convention,
                name=name,
                side=side,
                index=index,
                description="bevel",
                extension="crvGuide",
            ),
        )
        cmds.connectAttr(f"{mesh}.matrix", f"{edge_to_cruve}.inputMat", force=True)
        condition = cmds.createNode("condition")
        cmds.connectAttr(negate_plug, f"{condition}.firstTerm")
        cmds.setAttr(f"{condition}.secondTerm", -1)
        cmds.setAttr(f"{condition}.colorIfTrueR", 1)
        cmds.setAttr(f"{condition}.colorIfFalseR", 0)
        sweep = cmds.createNode("sweepMeshCreator")
        cmds.connectAttr(f"{condition}.outColorR", f"{sweep}.normalsReverse")
        cmds.setAttr(f"{sweep}.interpolationPrecision", 0)
        cmds.connectAttr(f"{curve}.local", f"{sweep}.inCurveArray[0]")
        cmds.connectAttr(f"{self.guide_root}.radius", f"{sweep}.scaleProfileX")
        cmds.connectAttr(f"{self.guide_root}.radius", f"{sweep}.scaleProfileY")
        cmds.parent(mesh, curve, self.guide_root)
        cmds.setAttr(f"{mesh}.t", 0, 0, 0)
        cmds.setAttr(f"{mesh}.r", 0, 0, 0)
        cmds.setAttr(f"{mesh}.s", 1, 1, 1)
        cmds.setAttr(f"{curve}.t", 0, 0, 0)
        cmds.setAttr(f"{curve}.r", 0, 0, 0)
        cmds.setAttr(f"{curve}.s", 1, 1, 1)

        # guide
        root_guide = self.add_guide(
            parent=self.guide_root,
            description="root",
            m=self["guide_matrix"]["value"][0],
            mirror_type=1,
        )
        root_inverse = cmds.createNode(
            "transform", name=f"{root_guide}_inverse", parent=None
        )
        root_inverse = cmds.parent(root_inverse, root_guide)[0]
        cmds.setAttr(f"{root_inverse}.t", 0, 0, 0)
        cmds.setAttr(f"{root_inverse}.r", 0, 0, 0)
        cmds.setAttr(f"{root_inverse}.s", 1, 1, 1)

        multiply = cmds.createNode("multiply")
        cmds.setAttr(f"{multiply}.input[0]", 2)
        cmds.connectAttr(f"{self.guide_root}.scaled_radius", f"{multiply}.input[1]")

        pma = cmds.createNode("plusMinusAverage")
        cmds.setAttr(f"{pma}.operation", 2)
        cmds.connectAttr(f"{self.guide_root}.scaled_height", f"{pma}.input1D[0]")
        cmds.connectAttr(f"{multiply}.output", f"{pma}.input1D[1]")
        cmds.connectAttr(f"{self.guide_root}.next_chain_offset", f"{pma}.input1D[2]")
        chain_offset_plug = f"{pma}.output1D"

        multiply = cmds.createNode("multiply")
        cmds.connectAttr(chain_offset_plug, f"{multiply}.input[0]")
        cmds.connectAttr(negate_plug, f"{multiply}.input[1]")
        divide = cmds.createNode("divide")
        cmds.connectAttr(f"{multiply}.output", f"{divide}.input1")
        root_guide_decom_m = cmds.createNode("decomposeMatrix")
        cmds.connectAttr(
            f"{root_guide}.worldMatrix[0]", f"{root_guide_decom_m}.inputMatrix"
        )
        cmds.connectAttr(f"{root_guide_decom_m}.outputScaleX", f"{divide}.input2")
        negated_chain_offset_plug = f"{divide}.output"

        compose_m = cmds.createNode("composeMatrix")
        cmds.connectAttr(negate_plug, f"{compose_m}.inputScaleX")
        cmds.connectAttr(negate_plug, f"{compose_m}.inputScaleY")
        cmds.connectAttr(negate_plug, f"{compose_m}.inputScaleZ")
        c_tg0 = cmds.createNode("transformGeometry")
        cmds.connectAttr(f"{compose_m}.outputMatrix", f"{c_tg0}.transform")
        cmds.connectAttr(f"{sweep}.outMeshArray[0]", f"{c_tg0}.inputGeometry")

        compose_m = cmds.createNode("composeMatrix")
        cmds.setAttr(f"{compose_m}.inputRotateX", 90)
        cmds.connectAttr(negate_plug, f"{compose_m}.inputScaleX")
        cmds.connectAttr(negate_plug, f"{compose_m}.inputScaleY")
        cmds.connectAttr(negate_plug, f"{compose_m}.inputScaleZ")
        c_tg1 = cmds.createNode("transformGeometry")
        cmds.connectAttr(f"{compose_m}.outputMatrix", f"{c_tg1}.transform")
        cmds.connectAttr(f"{sweep}.outMeshArray[0]", f"{c_tg1}.inputGeometry")

        chain_meshes = []
        main_joints = []
        up_joints = []
        m_parent = root_inverse
        u_parent = root_inverse
        for i in range(self["chain_count"]["value"] + 1):
            if i < self["chain_count"]["value"]:
                c_mesh = cmds.polyCube(
                    constructionHistory=False,
                    name=Name.create(
                        Name.controller_name_convention,
                        name=name,
                        side=side,
                        index=index,
                        description=f"chain{i}",
                        extension="meshGuide",
                    ),
                )[0]
                if i % 2 == 0:
                    cmds.connectAttr(f"{c_tg0}.outputGeometry", f"{c_mesh}.inMesh")
                else:
                    cmds.connectAttr(f"{c_tg1}.outputGeometry", f"{c_mesh}.inMesh")
                chain_meshes.append(c_mesh)

            m_jnt = cmds.createNode(
                "joint",
                name=Name.create(
                    Name.controller_name_convention,
                    name=name,
                    side=side,
                    index=index,
                    description=f"main{i}",
                    extension="jntGuide",
                ),
                parent=m_parent,
            )
            m_parent = m_jnt
            main_joints.append(m_jnt)
            u_jnt = cmds.createNode(
                "joint",
                name=Name.create(
                    Name.controller_name_convention,
                    name=name,
                    side=side,
                    index=index,
                    description=f"up{i}",
                    extension="jntGuide",
                ),
                parent=u_parent,
            )
            u_parent = u_jnt
            up_joints.append(u_jnt)
            if i == 0:
                continue
            cmds.connectAttr(negated_chain_offset_plug, f"{m_jnt}.translateX")
            cmds.connectAttr(negated_chain_offset_plug, f"{u_jnt}.translateX")

        chain_mesh_grp = cmds.createNode(
            "transform",
            name=Name.create(
                Name.controller_name_convention,
                name=name,
                side=side,
                index=index,
                description="chainMesh",
                extension=Name.group_extension,
            ),
            parent=self.guide_root,
        )
        cmds.parent(chain_meshes, chain_mesh_grp)
        cmds.hide(main_joints[0], up_joints[0])

        line = cmds.curve(degree=1, p=[(0, 0, 0), (0, 0, 0)])
        line = cmds.rename(
            line,
            Name.create(
                Name.controller_name_convention,
                name=name,
                side=side,
                index=index,
                extension="lineGuide",
            ),
        )
        cmds.setAttr(f"{line}.inheritsTransform", 0)
        line = cmds.parent(line, self.guide_root)[0]
        cmds.setAttr(f"{line}.t", 0, 0, 0)
        cmds.setAttr(f"{line}.r", 0, 0, 0)
        cmds.setAttr(f"{line}.s", 1, 1, 1)
        divide = cmds.createNode("divide")
        cmds.connectAttr(chain_offset_plug, f"{divide}.input1")
        cmds.connectAttr(f"{self.guide_root}.sx", f"{divide}.input2")
        multiply = cmds.createNode("multiply")
        cmds.connectAttr(f"{divide}.output", f"{multiply}.input[0]")
        cmds.connectAttr(f"{self.guide_root}.chain_count", f"{multiply}.input[1]")
        cmds.connectAttr(f"{multiply}.output", f"{line}.controlPoints[1].yValue")

        # master surf
        rebuild_crv0 = cmds.createNode("rebuildCurve")
        cmds.setAttr(f"{rebuild_crv0}.degree", 1)
        cmds.setAttr(f"{rebuild_crv0}.rebuildType", 0)
        cmds.setAttr(f"{rebuild_crv0}.keepRange", 0)
        cmds.setAttr(f"{rebuild_crv0}.fitRebuild", 0)
        cmds.setAttr(f"{rebuild_crv0}.spans", self["master_layer_count"]["value"] - 1)
        cmds.connectAttr(f"{line}.local", f"{rebuild_crv0}.inputCurve")

        rebuild_crv1 = cmds.createNode("rebuildCurve")
        cmds.setAttr(f"{rebuild_crv1}.fitRebuild", 0)
        cmds.setAttr(f"{rebuild_crv1}.rebuildType", 0)
        cmds.setAttr(f"{rebuild_crv1}.keepControlPoints", 1)
        if self["master_layer_count"]["value"] == 2:
            cmds.setAttr(f"{rebuild_crv1}.degree", 1)
        elif self["master_layer_count"]["value"] == 3:
            cmds.setAttr(f"{rebuild_crv1}.degree", 2)
        else:
            cmds.setAttr(f"{rebuild_crv1}.degree", 3)
        cmds.connectAttr(f"{rebuild_crv0}.outputCurve", f"{rebuild_crv1}.inputCurve")

        offset_curve0 = cmds.createNode("offsetCurve")
        cmds.setAttr(f"{offset_curve0}.normal", 0, 0, 1)
        cmds.connectAttr(
            f"{self.guide_root}.surface_width", f"{offset_curve0}.distance"
        )
        cmds.connectAttr(f"{rebuild_crv1}.outputCurve", f"{offset_curve0}.inputCurve")

        offset_curve1 = cmds.createNode("offsetCurve")
        cmds.setAttr(f"{offset_curve1}.normal", 0, 0, -1)
        cmds.connectAttr(
            f"{self.guide_root}.surface_width", f"{offset_curve1}.distance"
        )
        cmds.connectAttr(f"{rebuild_crv1}.outputCurve", f"{offset_curve1}.inputCurve")

        loft0 = cmds.createNode("loft")
        cmds.setAttr(f"{loft0}.degree", 1)
        cmds.setAttr(f"{loft0}.reverseSurfaceNormals", 1)
        cmds.connectAttr(f"{offset_curve0}.outputCurve[0]", f"{loft0}.inputCurve[0]")
        cmds.connectAttr(f"{offset_curve1}.outputCurve[0]", f"{loft0}.inputCurve[1]")

        rebuild_surface0 = cmds.createNode("rebuildSurface")
        cmds.connectAttr(f"{loft0}.outputSurface", f"{rebuild_surface0}.inputSurface")
        cmds.setAttr(f"{rebuild_surface0}.rebuildType", 0)
        cmds.setAttr(f"{rebuild_surface0}.degreeU", 0)
        cmds.setAttr(f"{rebuild_surface0}.degreeV", 0)
        cmds.setAttr(f"{rebuild_surface0}.keepRange", 0)
        cmds.setAttr(f"{rebuild_surface0}.keepCorners", 1)
        cmds.setAttr(f"{rebuild_surface0}.keepControlPoints", 1)

        master_surf = cmds.nurbsPlane(
            name=Name.create(
                Name.controller_name_convention,
                name=name,
                side=side,
                index=index,
                description="master",
                extension="surfGuide",
            ),
            constructionHistory=False,
        )
        master_surf = cmds.parent(master_surf, self.guide_root)[0]
        cmds.connectAttr(
            f"{rebuild_surface0}.outputSurface", f"{master_surf}Shape.create"
        )

        # sub surf
        rebuild_crv2 = cmds.createNode("rebuildCurve")
        cmds.setAttr(f"{rebuild_crv2}.degree", 1)
        cmds.setAttr(f"{rebuild_crv2}.rebuildType", 0)
        cmds.setAttr(f"{rebuild_crv2}.keepRange", 0)
        cmds.setAttr(f"{rebuild_crv2}.fitRebuild", 0)
        cmds.setAttr(f"{rebuild_crv2}.spans", self["sub_layer_count"]["value"] - 1)
        cmds.connectAttr(f"{line}.local", f"{rebuild_crv2}.inputCurve")

        rebuild_crv3 = cmds.createNode("rebuildCurve")
        cmds.setAttr(f"{rebuild_crv3}.rebuildType", 0)
        cmds.setAttr(f"{rebuild_crv3}.keepControlPoints", 1)
        cmds.setAttr(f"{rebuild_crv3}.degree", 3)
        cmds.setAttr(f"{rebuild_crv3}.fitRebuild", 0)
        cmds.connectAttr(f"{rebuild_crv2}.outputCurve", f"{rebuild_crv3}.inputCurve")

        offset_curve2 = cmds.createNode("offsetCurve")
        cmds.setAttr(f"{offset_curve2}.normal", 0, 0, 1)
        cmds.connectAttr(
            f"{self.guide_root}.surface_width", f"{offset_curve2}.distance"
        )
        cmds.connectAttr(f"{rebuild_crv3}.outputCurve", f"{offset_curve2}.inputCurve")

        offset_curve3 = cmds.createNode("offsetCurve")
        cmds.setAttr(f"{offset_curve3}.normal", 0, 0, -1)
        cmds.connectAttr(
            f"{self.guide_root}.surface_width", f"{offset_curve3}.distance"
        )
        cmds.connectAttr(f"{rebuild_crv3}.outputCurve", f"{offset_curve3}.inputCurve")

        loft1 = cmds.createNode("loft")
        cmds.setAttr(f"{loft1}.degree", 1)
        cmds.setAttr(f"{loft1}.reverseSurfaceNormals", 1)
        cmds.connectAttr(f"{offset_curve2}.outputCurve[0]", f"{loft1}.inputCurve[0]")
        cmds.connectAttr(f"{offset_curve3}.outputCurve[0]", f"{loft1}.inputCurve[1]")

        rebuild_surface1 = cmds.createNode("rebuildSurface")
        cmds.connectAttr(f"{loft1}.outputSurface", f"{rebuild_surface1}.inputSurface")
        cmds.setAttr(f"{rebuild_surface1}.rebuildType", 0)
        cmds.setAttr(f"{rebuild_surface1}.degreeU", 0)
        cmds.setAttr(f"{rebuild_surface1}.degreeV", 0)
        cmds.setAttr(f"{rebuild_surface1}.keepRange", 0)
        cmds.setAttr(f"{rebuild_surface1}.keepCorners", 1)
        cmds.setAttr(f"{rebuild_surface1}.keepControlPoints", 1)

        sub_surf = cmds.nurbsPlane(
            name=Name.create(
                Name.controller_name_convention,
                name=name,
                side=side,
                index=index,
                description="sub",
                extension="surfGuide",
            ),
            constructionHistory=False,
        )
        sub_surf = cmds.parent(sub_surf, self.guide_root)[0]
        cmds.connectAttr(f"{rebuild_surface1}.outputSurface", f"{sub_surf}Shape.create")

        master_npos = []
        master_guides = []
        master_joints = []
        master_guide_matrices = self["guide_matrix"]["value"][
            1 : int(self["master_layer_count"]["value"] * 2) + 1
        ]
        for i in range(self["master_layer_count"]["value"]):
            npo = cmds.createNode(
                "transform",
                name=Name.create(
                    Name.controller_name_convention,
                    name=name,
                    side=side,
                    index=index,
                    description=f"master{i}",
                    extension="guideNpo",
                ),
                parent=root_inverse,
            )
            poci = cmds.createNode("pointOnCurveInfo")
            cmds.setAttr(f"{poci}.turnOnPercentage", 1)
            cmds.connectAttr(f"{line}.local", f"{poci}.inputCurve")
            u_value = i / (self["master_layer_count"]["value"] - 1)
            cmds.setAttr(f"{poci}.parameter", u_value)

            cmds.connectAttr(f"{poci}.position", f"{npo}.translate")
            guide = self.add_guide(
                parent=npo,
                description=f"master{i}",
                m=master_guide_matrices[i * 2],
                mirror_type=1,
            )
            if master_guide_matrices[i * 2] == list(ORIGINMATRIX):
                cmds.setAttr(f"{guide}.t", 0, 0, 0)
                cmds.setAttr(f"{guide}.r", 0, 0, 0)
            rot_guide = self.add_guide(
                parent=guide,
                description=f"masterRot{i}",
                m=master_guide_matrices[i * 2 + 1],
                mirror_type=1,
            )
            if master_guide_matrices[i * 2 + 1] == list(ORIGINMATRIX):
                cmds.setAttr(f"{rot_guide}.t", 0, 0, 0)
                cmds.setAttr(f"{rot_guide}.r", 0, 0, 0)
            joint = cmds.createNode(
                "joint",
                name=Name.create(
                    Name.joint_name_convention,
                    name=name,
                    side=side,
                    index=index,
                    description=f"master{i}",
                    extension="guideJnt",
                ),
                parent=guide,
            )
            master_npos.append(npo)
            master_guides.append(rot_guide)
            master_joints.append(joint)

        sub_npos = []
        sub_joints = []
        sub_guides = []
        curve_from_surface_iso = cmds.createNode("curveFromSurfaceIso")
        cmds.connectAttr(
            f"{master_surf}.worldSpace[0]", f"{curve_from_surface_iso}.inputSurface"
        )
        cmds.setAttr(f"{curve_from_surface_iso}.isoparmValue", 0.5)
        rebuild_crv = cmds.createNode("rebuildCurve")
        cmds.setAttr(f"{rebuild_crv}.degree", 1)
        cmds.setAttr(f"{rebuild_crv}.tolerance", 0)
        cmds.setAttr(f"{rebuild_crv}.keepRange", 0)
        cmds.setAttr(f"{rebuild_crv}.spans", 99)
        cmds.connectAttr(
            f"{curve_from_surface_iso}.outputCurve", f"{rebuild_crv}.inputCurve"
        )

        pin = cmds.createNode("uvPin")
        cmds.setAttr(f"{pin}.relativeSpaceMode", 1)
        cmds.connectAttr(f"{master_surf}.worldSpace[0]", f"{pin}.deformedGeometry")
        curve_info = cmds.createNode("curveInfo")
        cmds.connectAttr(f"{line}.worldSpace[0]", f"{curve_info}.inputCurve")
        sub_guide_matrices = self["guide_matrix"]["value"][
            int(self["master_layer_count"]["value"] * 2) + 1 :
        ]
        for i in range(self["sub_layer_count"]["value"]):
            nearest_curve = cmds.createNode("nearestPointOnCurve")
            cmds.connectAttr(
                f"{curve_from_surface_iso}.outputCurve", f"{nearest_curve}.inputCurve"
            )
            poci = cmds.createNode("pointOnCurveInfo")
            cmds.connectAttr(f"{rebuild_crv}.outputCurve", f"{poci}.inputCurve")
            cmds.setAttr(f"{poci}.turnOnPercentage", 1)
            u_value = i / (self["sub_layer_count"]["value"] - 1)
            cmds.setAttr(f"{poci}.parameter", u_value)
            cmds.connectAttr(f"{poci}.position", f"{nearest_curve}.inPosition")
            cmds.connectAttr(
                f"{nearest_curve}.parameter", f"{pin}.coordinate[{i}].coordinateU"
            )
            cmds.setAttr(f"{pin}.coordinate[{i}].coordinateV", 0.5)
            cmds.connectAttr(
                f"{nearest_curve}.parameter",
                f"{self.guide_root}.sub_driver_u_values[{i}]",
            )

            npo = cmds.createNode(
                "transform",
                name=Name.create(
                    Name.controller_name_convention,
                    name=name,
                    side=side,
                    index=index,
                    description=f"sub{i}",
                    extension="guideNpo",
                ),
                parent=root_inverse,
            )
            cmds.connectAttr(f"{pin}.outputMatrix[{i}]", f"{npo}.offsetParentMatrix")
            guide = self.add_guide(
                parent=None,
                description=f"sub{i}",
                m=sub_guide_matrices[i],
                mirror_type=self["guide_mirror_type"]["value"][i],
            )
            cmds.connectAttr(
                f"{guide}.dagLocalMatrix", f"{self.guide_root}.sub_driver_matrix[{i}]"
            )
            pick_m = cmds.createNode("pickMatrix")
            cmds.setAttr(f"{pick_m}.useScale", 0)
            cmds.setAttr(f"{pick_m}.useShear", 0)
            cmds.connectAttr(f"{guide}.worldInverseMatrix[0]", f"{pick_m}.inputMatrix")
            cmds.connectAttr(
                f"{pick_m}.outputMatrix",
                f"{self.guide_root}.sub_driver_inverse_matrix[{i}]",
            )

            joint = cmds.createNode(
                "joint",
                name=Name.create(
                    Name.joint_name_convention,
                    name=name,
                    side=side,
                    index=index,
                    description=f"sub{i}",
                    extension="guideJnt",
                ),
                parent=guide,
            )
            sub_npos.append(npo)
            sub_joints.append(joint)
            sub_guides.append(guide)
        cmds.hide(master_joints + sub_joints)

        master_surf, sub_surf = cmds.parent([master_surf, sub_surf], root_inverse)
        cmds.setAttr(f"{master_surf}.t", 0, 0, 0)
        cmds.setAttr(f"{master_surf}.r", 0, 0, 0)
        cmds.setAttr(f"{master_surf}.s", 1, 1, 1)
        cmds.setAttr(f"{sub_surf}.t", 0, 0, 0)
        cmds.setAttr(f"{sub_surf}.r", 0, 0, 0)
        cmds.setAttr(f"{sub_surf}.s", 1, 1, 1)
        master_sc = rigkit.bind_skincluster(
            master_surf, master_joints, f"{master_surf}0_sc"
        )
        cmds.connectAttr(f"{master_surf}.worldMatrix[0]", f"{master_sc}.geomMatrix")
        for i in range(self["master_layer_count"]["value"]):
            cmds.skinPercent(
                master_sc,
                f"{master_surf}.cv[{i}][*]",
                transformValue=[master_joints[i], 1],
            )
            cmds.connectAttr(
                f"{master_npos[i]}.worldInverseMatrix[0]",
                f"{master_sc}.bindPreMatrix[{i}]",
            )

        for guide, npo in zip(sub_guides, sub_npos):
            cmds.parent(guide, npo)
            if sub_guide_matrices[i] == list(ORIGINMATRIX):
                cmds.setAttr(f"{guide}.t", 0, 0, 0)
                cmds.setAttr(f"{guide}.r", 0, 0, 0)

        sub_sc = rigkit.bind_skincluster(
            sub_surf,
            sub_joints,
            f"{sub_surf}0_sc",
        )
        cmds.connectAttr(f"{sub_surf}.worldMatrix[0]", f"{sub_sc}.geomMatrix")
        for i in range(self["sub_layer_count"]["value"]):
            cmds.skinPercent(
                sub_sc,
                f"{sub_surf}.cv[{i}][*]",
                transformValue=[sub_joints[i], 1],
            )
            poci = cmds.createNode("pointOnCurveInfo")
            cmds.setAttr(f"{poci}.turnOnPercentage", 1)
            cmds.connectAttr(f"{line}.worldSpace[0]", f"{poci}.inputCurve")
            u_value = i / (self["sub_layer_count"]["value"] - 1)
            cmds.setAttr(f"{poci}.parameter", u_value)
            compose_m = cmds.createNode("composeMatrix")
            cmds.setAttr(f"{compose_m}.inputRotate", -90, 90, 0)
            cmds.connectAttr(f"{poci}.position", f"{compose_m}.inputTranslate")
            mult_m = cmds.createNode("multMatrix")
            cmds.connectAttr(f"{compose_m}.outputMatrix", f"{mult_m}.matrixIn[0]")
            cmds.connectAttr(f"{sub_surf}.worldMatrix[0]", f"{mult_m}.matrixIn[1]")
            pick_m = cmds.createNode("pickMatrix")
            cmds.setAttr(f"{pick_m}.useScale", 0)
            cmds.connectAttr(f"{mult_m}.matrixSum", f"{pick_m}.inputMatrix")
            inverse_m = cmds.createNode("inverseMatrix")
            cmds.connectAttr(f"{pick_m}.outputMatrix", f"{inverse_m}.inputMatrix")
            cmds.connectAttr(
                f"{inverse_m}.outputMatrix", f"{sub_sc}.bindPreMatrix[{i}]"
            )

        tg = cmds.createNode("transformGeometry")
        cmds.connectAttr(f"{master_surf}.worldSpace[0]", f"{tg}.inputGeometry")
        cmds.connectAttr(f"{master_surf}.worldMatrix[0]", f"{tg}.transform")
        cmds.connectAttr(
            f"{tg}.outputGeometry", f"{self.guide_root}.master_layer_surface"
        )

        tg = cmds.createNode("transformGeometry")
        cmds.connectAttr(f"{sub_surf}.worldSpace[0]", f"{tg}.inputGeometry")
        cmds.connectAttr(f"{sub_surf}.worldMatrix[0]", f"{tg}.transform")
        cmds.connectAttr(f"{tg}.outputGeometry", f"{self.guide_root}.sub_layer_surface")

        main_curve_from_surface_iso = cmds.createNode("curveFromSurfaceIso")
        cmds.connectAttr(
            f"{sub_surf}.local", f"{main_curve_from_surface_iso}.inputSurface"
        )
        cmds.setAttr(f"{main_curve_from_surface_iso}.isoparmValue", 0.5)
        up_curve_from_surface_iso = cmds.createNode("curveFromSurfaceIso")
        cmds.connectAttr(
            f"{sub_surf}.local", f"{up_curve_from_surface_iso}.inputSurface"
        )
        main_ik_crv = cmds.circle(
            name=Name.create(
                Name.controller_name_convention,
                name=name,
                side=side,
                index=index,
                description="mainIk",
                extension="crvGuide",
            ),
            constructionHistory=False,
        )[0]
        cmds.connectAttr(
            f"{main_curve_from_surface_iso}.outputCurve", f"{main_ik_crv}.create"
        )
        main_ikh, effector = cmds.ikHandle(
            startJoint=main_joints[0],
            endEffector=main_joints[-1],
            solver="ikSplineSolver",
            name=f"{main_ik_crv}_mainIkh",
            curve=main_ik_crv,
            createCurve=False,
        )
        main_ikh = cmds.parent(main_ikh, self.guide_root)[0]
        up_ik_crv = cmds.circle(
            name=Name.create(
                Name.controller_name_convention,
                name=name,
                side=side,
                index=index,
                description="upIk",
                extension="crvGuide",
            ),
            constructionHistory=False,
        )[0]
        cmds.connectAttr(
            f"{up_curve_from_surface_iso}.outputCurve", f"{up_ik_crv}.create"
        )
        up_ikh, effector = cmds.ikHandle(
            startJoint=up_joints[0],
            endEffector=up_joints[-1],
            solver="ikSplineSolver",
            name=f"{up_ik_crv}_upIkh",
            curve=up_ik_crv,
            createCurve=False,
        )
        up_ikh = cmds.parent(up_ikh, self.guide_root)[0]
        cmds.setAttr(f"{main_ik_crv}.t", 0, 0, 0)
        cmds.setAttr(f"{main_ik_crv}.r", 0, 0, 0)
        cmds.setAttr(f"{main_ik_crv}.s", 1, 1, 1)
        cmds.setAttr(f"{up_ik_crv}.t", 0, 0, 0)
        cmds.setAttr(f"{up_ik_crv}.r", 0, 0, 0)
        cmds.setAttr(f"{up_ik_crv}.s", 1, 1, 1)
        cmds.hide(mesh, curve, line, main_ik_crv, up_ik_crv, main_ikh, up_ikh)

        primary_objs = main_joints[1:] + [main_joints[-2]]
        i = 0
        compose_m = cmds.createNode("composeMatrix")
        cmds.connectAttr(
            f"{self.guide_root}.offset_output_rotate_x", f"{compose_m}.inputRotateX"
        )
        cmds.connectAttr(
            f"{self.guide_root}.offset_output_rotate_y", f"{compose_m}.inputRotateY"
        )
        cmds.connectAttr(
            f"{self.guide_root}.offset_output_rotate_z", f"{compose_m}.inputRotateZ"
        )
        for m_j, u_j in zip(main_joints, up_joints):
            pick_m = cmds.createNode("pickMatrix")
            cmds.setAttr(f"{pick_m}.useScale", 0)
            cmds.connectAttr(f"{m_j}.worldMatrix[0]", f"{pick_m}.inputMatrix")
            aim_m = cmds.createNode("aimMatrix")
            cmds.connectAttr(f"{pick_m}.outputMatrix", f"{aim_m}.inputMatrix")
            cmds.setAttr(f"{aim_m}.primaryMode", 1)
            cmds.setAttr(f"{aim_m}.secondaryMode", 1)
            cmds.setAttr(f"{aim_m}.primaryInputAxis", 0, 0, 0)
            cmds.setAttr(f"{aim_m}.secondaryInputAxis", 0, 0, 0)
            if i == len(main_joints) - 1:
                multiply = cmds.createNode("multiply")
                cmds.setAttr(f"{multiply}.input[0]", -1)
                cmds.connectAttr(negate_plug, f"{multiply}.input[1]")
                cmds.connectAttr(f"{multiply}.output", f"{aim_m}.primaryInputAxisX")
                cmds.connectAttr(f"{multiply}.output", f"{aim_m}.secondaryInputAxisY")
            else:
                cmds.connectAttr(negate_plug, f"{aim_m}.primaryInputAxisX")
                cmds.connectAttr(negate_plug, f"{aim_m}.secondaryInputAxisY")
            pick_m = cmds.createNode("pickMatrix")
            cmds.setAttr(f"{pick_m}.useScale", 0)
            cmds.connectAttr(
                f"{primary_objs[i]}.worldMatrix[0]", f"{pick_m}.inputMatrix"
            )
            cmds.connectAttr(f"{pick_m}.outputMatrix", f"{aim_m}.primaryTargetMatrix")
            pick_m = cmds.createNode("pickMatrix")
            cmds.setAttr(f"{pick_m}.useScale", 0)
            cmds.connectAttr(f"{u_j}.worldMatrix[0]", f"{pick_m}.inputMatrix")
            cmds.connectAttr(f"{pick_m}.outputMatrix", f"{aim_m}.secondaryTargetMatrix")
            mult_m = cmds.createNode("multMatrix")
            cmds.connectAttr(f"{compose_m}.outputMatrix", f"{mult_m}.matrixIn[0]")
            cmds.connectAttr(f"{aim_m}.outputMatrix", f"{mult_m}.matrixIn[1]")
            cmds.connectAttr(
                f"{self.guide_root}.worldInverseMatrix[0]", f"{mult_m}.matrixIn[2]"
            )
            if i < len(main_joints) - 1:
                decom_m = cmds.createNode("decomposeMatrix")
                cmds.connectAttr(f"{mult_m}.matrixSum", f"{decom_m}.inputMatrix")
                cmds.connectAttr(f"{decom_m}.outputTranslate", f"{chain_meshes[i]}.t")
                cmds.connectAttr(f"{decom_m}.outputRotate", f"{chain_meshes[i]}.r")
                cmds.connectAttr(f"{decom_m}.outputScale", f"{chain_meshes[i]}.s")

            cmds.connectAttr(
                f"{mult_m}.matrixSum",
                f"{self.guide_root}.initialize_output_matrix[{i}]",
            )
            inverse_m = cmds.createNode("inverseMatrix")
            cmds.connectAttr(f"{mult_m}.matrixSum", f"{inverse_m}.inputMatrix")
            cmds.connectAttr(
                f"{inverse_m}.outputMatrix",
                f"{self.guide_root}.initialize_output_inverse_matrix[{i}]",
            )
            i += 1

        parent = self.guide_root
        for i in range(self["chain_count"]["value"] + 1):
            dynamic_obj = cmds.createNode(
                "transform",
                name=Name.create(
                    Name.controller_name_convention,
                    name=name,
                    side=side,
                    index=index,
                    description=f"dynamic{i}",
                    extension="rot",
                ),
                parent=parent,
            )

            mult_m = cmds.createNode("multMatrix")
            cmds.connectAttr(
                f"{self.guide_root}.initialize_output_matrix[{i}]",
                f"{mult_m}.matrixIn[0]",
            )
            cmds.connectAttr(
                f"{dynamic_obj}.parentInverseMatrix", f"{mult_m}.matrixIn[1]"
            )
            decom_m = cmds.createNode("decomposeMatrix")
            cmds.connectAttr(f"{mult_m}.matrixSum", f"{decom_m}.inputMatrix")
            cmds.connectAttr(f"{decom_m}.outputTranslate", f"{dynamic_obj}.t")
            cmds.connectAttr(f"{decom_m}.outputRotate", f"{dynamic_obj}.r")
            parent = dynamic_obj

            cmds.connectAttr(
                f"{dynamic_obj}.rx", f"{self.guide_root}.dyn_ik_rotate_x[{i}]"
            )
            cmds.connectAttr(
                f"{dynamic_obj}.ry", f"{self.guide_root}.dyn_ik_rotate_y[{i}]"
            )
            cmds.connectAttr(
                f"{dynamic_obj}.rz", f"{self.guide_root}.dyn_ik_rotate_z[{i}]"
            )

        cmds.connectAttr(f"{chain_meshes[0]}.outMesh", f"{self.guide_root}.chain_mesh")

        distance = cmds.createNode("distanceBetween")
        cmds.connectAttr(f"{main_joints[0]}.worldMatrix[0]", f"{distance}.inMatrix1")
        cmds.connectAttr(f"{main_joints[1]}.worldMatrix[0]", f"{distance}.inMatrix2")
        cmds.connectAttr(f"{distance}.distance", f"{self.guide_root}.chain_distance")

        for i in range(self["chain_count"]["value"]):
            if i == 0:
                decom_m = cmds.createNode("decomposeMatrix")
                cmds.connectAttr(
                    f"{main_joints[i]}.worldMatrix[0]", f"{decom_m}.inputMatrix"
                )
                cmds.connectAttr(
                    f"{decom_m}.outputRotateX",
                    f"{self.guide_root}.main_ik_rotate_x[{i}]",
                )
                cmds.connectAttr(
                    f"{decom_m}.outputRotateY",
                    f"{self.guide_root}.main_ik_rotate_y[{i}]",
                )
                cmds.connectAttr(
                    f"{decom_m}.outputRotateZ",
                    f"{self.guide_root}.main_ik_rotate_z[{i}]",
                )
                decom_m = cmds.createNode("decomposeMatrix")
                cmds.connectAttr(
                    f"{up_joints[i]}.worldMatrix[0]", f"{decom_m}.inputMatrix"
                )
                cmds.connectAttr(
                    f"{decom_m}.outputRotateX", f"{self.guide_root}.up_ik_rotate_x[{i}]"
                )
                cmds.connectAttr(
                    f"{decom_m}.outputRotateY", f"{self.guide_root}.up_ik_rotate_y[{i}]"
                )
                cmds.connectAttr(
                    f"{decom_m}.outputRotateZ", f"{self.guide_root}.up_ik_rotate_z[{i}]"
                )
                continue
            cmds.connectAttr(
                f"{main_joints[i]}.rx", f"{self.guide_root}.main_ik_rotate_x[{i}]"
            )
            cmds.connectAttr(
                f"{main_joints[i]}.ry", f"{self.guide_root}.main_ik_rotate_y[{i}]"
            )
            cmds.connectAttr(
                f"{main_joints[i]}.rz", f"{self.guide_root}.main_ik_rotate_z[{i}]"
            )
            cmds.connectAttr(
                f"{up_joints[i]}.rx", f"{self.guide_root}.up_ik_rotate_x[{i}]"
            )
            cmds.connectAttr(
                f"{up_joints[i]}.ry", f"{self.guide_root}.up_ik_rotate_y[{i}]"
            )
            cmds.connectAttr(
                f"{up_joints[i]}.rz", f"{self.guide_root}.up_ik_rotate_z[{i}]"
            )

        c = 0
        for m in master_guides:
            pick_m = cmds.createNode("pickMatrix")
            cmds.setAttr(f"{pick_m}.useScale", 0)
            cmds.setAttr(f"{pick_m}.useShear", 0)
            cmds.connectAttr(f"{m}.worldMatrix[0]", f"{pick_m}.inputMatrix")
            cmds.connectAttr(
                f"{pick_m}.outputMatrix", f"{self.guide_root}.npo_matrix[{c}]"
            )
            c += 1

        for s in sub_guides:
            pick_m = cmds.createNode("pickMatrix")
            cmds.setAttr(f"{pick_m}.useScale", 0)
            cmds.setAttr(f"{pick_m}.useShear", 0)
            cmds.connectAttr(f"{s}.worldMatrix[0]", f"{pick_m}.inputMatrix")
            cmds.connectAttr(
                f"{pick_m}.outputMatrix", f"{self.guide_root}.npo_matrix[{c}]"
            )
            c += 1

    # endregion
